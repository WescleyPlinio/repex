{% extends 'base.html' %}
{% load static news_extras %}
{% block title %}
  Explorar projetos
{% endblock %}

{% block content %}
  <nav class="d-flex justify-content-center flex-wrap gap-2">
    <form method="get" id="filtros-form" name="q" value="{{ query }}" style="{% if identidade_visual.cor_suplente %}
           background: linear-gradient(to right, {{ identidade_visual.cor_sistema }}, {{ identidade_visual.cor_suplente }});
        {% else %}
          background-color: {{ identidade_visual.cor_sistema }};
        {% endif %}" class="mb-4 d-flex justify-content-between gap-2 flex-wrap p-3 rounded rounded-4">
      <h6 class="my-auto fw-bold text-white"><i class="fa-solid fa-filter fa-sm text-white"></i> FILTROS:</h6>
     <select name="area_conhecimento" class="rounded-pill form-select form-select-sm border border-0 w-auto bg-white py-2">
        <option class="mx-2" value="">√ÅREAS DE CONHECIMENTO</option>
        {% for area in areas %}
          <option class="border border-0" value="{{ area.id }}" {% if request.GET.area_conhecimento == area.id %}selected{% endif %}>{{ area.area }}</option>
        {% endfor %}
      </select>

      <select name="modalidade" class="rounded-pill form-select form-select-sm border border-0 w-auto bg-white py-2">
        <option class="mx-2" value="">MODALIDADE</option>
        {% for valor, label in modalidade_choices %}
          <option class="border border-0" value="{{ valor }}" {% if modalidade_selected == valor %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <select name="status" class="rounded-pill form-select form-select-sm border border-0 w-auto bg-white py-2">
        <option class="mx-2" value="">STATUS</option>
        {% for valor, label in status_choices %}
          <option class="border border-0" value="{{ valor }}" {% if status_selected == valor %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </form>
  </nav>

  <div class="carousel-shell mb-5">
    {% if query or request.GET.status or request.GET.modalidade %}
    <h4 style="color: {{ identidade_visual.cor_sistema }};">Projetos correspondentes:</h4>
    {% endif %}
    <div id="spinner" class="text-center m-auto" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
    </div>
    <div id="ajax_projetos">
      {% include 'partials/_ajax_projetos.html' %}
    </div>
  </div>

{% endblock %}

{% block extra_scripts %}
  <script>
    $(document).on('change', '#filtros-form select', function () {
      let formData = $('#filtros-form').serialize()
      let query = $('#search-projetos').val()
      $.ajax({
        url: "{% url 'ajax_projetos' %}",
        type: 'GET',
        data: formData + '&q=' + encodeURIComponent(query),
        beforeSend: function () {
          $('#spinner').show()
        },
        success: function (data) {
          $('#ajax_projetos').html(data.html)
        },
        complete: function () {
          $('#spinner').hide()
        }
      })
    })
    
    $(document).on('click', '#ajax_projetos .pagination a', function (e) {
      e.preventDefault()
      let page = $(this).attr('href').split('page=')[1] || 1
      let formData = $('#filtros-form').serialize()
      let query = $('#search-projetos').val()
    
      $.ajax({
        url: "{% url 'ajax_projetos' %}",
        type: 'GET',
        data: formData + '&q=' + encodeURIComponent(query) + '&page=' + page,
        beforeSend: function () {
          $('#spinner').show()
        },
        success: function (data) {
          $('#ajax_projetos').html(data.html)
        },
        complete: function () {
          $('#spinner').hide()
        }
      })
    })
  </script>
{% endblock %}
